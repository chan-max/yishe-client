# 协议错误处理功能说明

## 概述

当Electron客户端出现"Protocol error: Connection closed"错误时，系统会自动显示用户弹窗，提示用户关闭客户端后重新启动。

## 功能特性

### 1. 自动检测协议错误
- 监控浏览器连接状态
- 检测"Protocol error"和"Connection closed"错误
- 在连接错误、操作失败、达到最大重连次数时触发弹窗

### 2. 用户友好的弹窗提示
弹窗包含以下信息：
- **标题**: 连接错误
- **消息**: 检测到浏览器连接协议错误
- **详细说明**: 
  - 建议关闭客户端后重新启动以恢复连接
  - 错误类型：Protocol error: Connection closed
  - 如果问题持续存在，请检查网络连接或联系技术支持

### 3. 用户操作选项
用户可以选择以下操作：
- **关闭客户端**: 直接退出应用程序
- **稍后重试**: 关闭弹窗，允许系统继续尝试重连
- **取消**: 关闭弹窗，不执行任何操作

### 4. 防重复弹窗机制
- 在5分钟内只显示一次弹窗
- 避免频繁打扰用户
- 用户选择"稍后重试"或"取消"时重置计时器

## 触发条件

弹窗会在以下情况下显示：

1. **连接错误事件**: 当连接管理器检测到协议错误时
2. **操作失败事件**: 当执行操作时遇到协议错误时
3. **达到最大重连次数**: 当自动重连次数达到上限时

## 错误检测逻辑

```typescript
// 检查错误消息是否包含协议错误关键词
if (errorMessage.includes('Protocol error') || errorMessage.includes('Connection closed')) {
  await showProtocolErrorDialog();
}
```

## 实现文件

- **主要实现**: `src/main/index.ts`
- **连接管理**: `src/main/connectionManager.ts`
- **测试脚本**: `test-protocol-error.js`

## 测试方法

1. 启动Electron应用
2. 运行测试脚本：
   ```bash
   node test-protocol-error.js
   ```
3. 观察弹窗显示和用户交互

## 配置参数

可以在`showProtocolErrorDialog`函数中调整以下参数：

- **弹窗类型**: `warning`
- **按钮选项**: `['关闭客户端', '稍后重试', '取消']`
- **防重复时间**: 5分钟（300000毫秒）
- **默认选择**: 第一个按钮（关闭客户端）

## 日志输出

系统会在控制台输出详细的日志信息：

```
🔄 检测到协议错误，显示用户提示弹窗...
用户选择关闭客户端
✅ 资源清理完成
```

## 注意事项

1. 弹窗只在主窗口存在时显示
2. 应用退出时会自动清理相关资源
3. 防重复机制确保用户体验友好
4. 错误处理包含完整的异常捕获 