# 网络连接恢复功能说明

## 概述

为了解决"Protocol error: Connection closed"问题，特别是在电脑待机或长时间未使用后出现的连接中断问题，我们实现了以下功能：

### 🔄 增强的连接管理器
- **心跳检测**: 每30秒检测一次浏览器连接状态
- **自动重连**: 检测到协议错误时自动重新连接
- **智能重试**: 指数退避算法，避免过度重试
- **状态监控**: 实时监控连接状态变化

### 🌐 网络监控服务
- **网络状态检测**: 定期检查网络连接状态
- **自动恢复**: 网络恢复后自动处理连接问题
- **多URL测试**: 使用多个网站测试网络连通性
- **延迟监控**: 监控网络延迟变化

## 功能特性

### 1. 协议错误自动处理
当检测到"Protocol error: Connection closed"时：
- 自动关闭现有浏览器实例
- 等待网络稳定（5秒延迟）
- 重新创建浏览器实例
- 恢复连接状态

### 2. 心跳检测机制
- **检测间隔**: 30秒
- **超时时间**: 10秒
- **失败处理**: 连续失败3次后触发重连

### 3. 网络状态监控
- **检查间隔**: 30秒
- **测试URL**: 百度、谷歌、必应
- **失败阈值**: 连续3次失败判定为网络断开
- **恢复延迟**: 5秒等待网络稳定

## 配置参数

### 连接管理器配置
```typescript
{
  maxRetries: 5,              // 最大重试次数
  retryDelay: 2000,           // 基础重试延迟 (毫秒)
  timeout: 30000,             // 超时时间 (毫秒)
  backoffMultiplier: 1.5,     // 退避倍数
  heartbeatInterval: 30000,   // 心跳检测间隔 (毫秒)
  heartbeatTimeout: 10000,    // 心跳超时时间 (毫秒)
  autoReconnect: true,        // 是否自动重连
  maxReconnectAttempts: 10    // 最大重连次数
}
```

### 网络监控配置
```typescript
{
  checkInterval: 30000,       // 网络检查间隔 (毫秒)
  timeout: 10000,            // 网络检查超时 (毫秒)
  maxFailures: 3,            // 最大连续失败次数
  recoveryDelay: 5000        // 恢复延迟 (毫秒)
}
```

## 使用场景

### 1. 电脑待机后恢复
当电脑从待机状态恢复时：
1. 网络监控检测到网络恢复
2. 自动检查浏览器连接状态
3. 如果发现协议错误，自动重连
4. 恢复正常的服务状态

### 2. 长时间未使用
当应用长时间未使用时：
1. 心跳检测发现连接断开
2. 自动触发重连机制
3. 重新创建浏览器实例
4. 恢复连接状态

### 3. 网络波动
当网络出现波动时：
1. 网络监控检测到连接问题
2. 等待网络稳定
3. 自动恢复连接
4. 继续提供服务

## 监控和调试

### 1. 控制台日志
应用会输出详细的连接状态日志：
```
✅ 连接检查成功，页面数量: 1
💓 心跳检测正常，页面数量: 1
🔄 检测到协议错误，尝试重新连接...
🌐 网络已恢复
✅ 浏览器实例重新创建成功
```

### 2. 状态监控
可以通过以下方式监控状态：
```typescript
// 获取连接状态
const connectionStatus = connectionManager.getStatus();

// 获取网络状态
const networkStatus = networkMonitor.getStatus();
```

### 3. 事件监听
可以监听各种状态变化事件：
```typescript
// 连接成功
connectionManager.on('connected', () => {
  console.log('连接已恢复');
});

// 网络恢复
networkMonitor.on('networkRestored', () => {
  console.log('网络已恢复');
});
```

## 故障排除

### 1. 频繁重连
如果出现频繁重连问题：
- 检查网络稳定性
- 增加重试延迟时间
- 调整最大重试次数

### 2. 重连失败
如果重连持续失败：
- 检查系统资源
- 验证网络连接
- 查看错误日志

### 3. 性能问题
如果出现性能问题：
- 调整心跳检测间隔
- 减少网络检查频率
- 优化重连策略

## 最佳实践

### 1. 合理配置参数
根据实际使用环境调整配置：
```typescript
// 网络较差的环境
connectionManager.updateConfig({
  retryDelay: 5000,
  maxRetries: 3,
  heartbeatInterval: 60000
});

// 网络较好的环境
connectionManager.updateConfig({
  retryDelay: 1000,
  maxRetries: 5,
  heartbeatInterval: 15000
});
```

### 2. 监控关键指标
定期检查以下指标：
- 连接成功率
- 重连频率
- 网络延迟
- 错误类型分布

### 3. 日志分析
定期分析日志以发现问题：
- 重连原因分析
- 网络问题模式
- 性能瓶颈识别

## 更新日志

### v1.1.0 (2025-01-27)
- 新增网络监控服务
- 增强连接管理器功能
- 添加心跳检测机制
- 实现自动重连功能
- 优化错误处理逻辑

### v1.0.0 (2025-01-27)
- 基础连接管理功能
- 简单的重试机制
- 基本错误处理 